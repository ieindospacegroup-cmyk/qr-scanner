<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner - FULFILMENT AQUATEAK 2026</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
            color: #ffffff;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            animation: fadeIn 0.8s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #3c3c3c 0%, #4a4a4a 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .scanner-section {
            background: linear-gradient(135deg, #3c3c3c 0%, #4a4a4a 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .scanner-status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .scanner-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .scanner-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .scanner-status.info {
            background: #4a4a4a;
            color: white;
            border: 1px solid #5a5a5a;
        }

        .scanner-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .btn:hover {
            background: linear-gradient(135deg, #e55a2b 0%, #ff6b35 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a4a4a 0%, #5a5a5a 100%);
            box-shadow: 0 4px 15px rgba(74, 74, 74, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #3a3a3a 0%, #4a4a4a 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #138496 0%, #17a2b8 100%);
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .result-section {
            background: linear-gradient(135deg, #3c3c3c 0%, #4a4a4a 100%);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            display: none;
        }

        .result-content {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            margin-bottom: 15px;
        }

        .manual-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #4a4a4a;
            border-radius: 8px;
            background: #2a2a2a;
            color: white;
            font-family: 'Courier New', monospace;
            resize: vertical;
            margin-bottom: 10px;
        }

        .manual-input:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            #qr-reader {
                max-width: 100%;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∑ QR Scanner - FULFILMENT AQUATEAK 2026</h1>
            <div id="scannerStatus" class="scanner-status info">Memulai scanner...</div>
        </div>

        <div class="scanner-section">
            <div id="qr-reader"></div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="startCameraScan()">üì∏ Start Camera</button>
                <button class="btn" onclick="stopCameraScan()">‚èπÔ∏è Stop Camera</button>
                <button class="btn btn-info" onclick="switchCamera()">üîÑ Switch Camera</button>
                <button class="btn btn-warning" onclick="requestCameraPermission()">üîÅ Request Camera Permission</button>
            </div>
        </div>

        <div class="scanner-section">
            <h3>üìù Manual Input</h3>
            <textarea id="manualInput" 
                      placeholder="Format: JO Number|Product Code|Product Name|QTY Order|Serial Number"
                      rows="3"
                      class="manual-input"></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="processManualInput()">üì∑ Process QR</button>
                <button class="btn" onclick="clearManualInput()">üóëÔ∏è Clear</button>
            </div>
        </div>

        <div id="resultSection" class="result-section">
            <h3>üìä Scan Result</h3>
            <div id="resultContent" class="result-content"></div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="sendToAppsScript()">üì§ Send to Dashboard</button>
                <button class="btn btn-info" onclick="copyResult()">üìã Copy Result</button>
                <button class="btn" onclick="resetScanner()">üîÑ Scan Again</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let html5QrCode = null;
        let lastScanResult = null;
        let cameras = [];
        let currentCameraId = null;

        // Get URL parameters
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Update scanner status
        function updateScannerStatus(message, type = 'info') {
            const statusDiv = document.getElementById('scannerStatus');
            statusDiv.textContent = message;
            statusDiv.className = 'scanner-status ' + type;
        }

        // Start camera scanner
        function startCameraScan() {
            console.log('=== STARTING CAMERA SCANNER ===');
            updateScannerStatus('üì∏ Memulai scanner kamera...', 'info');
            
            // Check if camera is supported
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateScannerStatus('‚ùå Browser tidak mendukung kamera. Gunakan Manual Input.', 'error');
                return;
            }

            // Initialize HTML5 QR Code
            try {
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                    console.log('HTML5 QR Code initialized');
                }

                // Get available cameras
                Html5Qrcode.getCameras().then(devices => {
                    cameras = devices;
                    console.log('Available cameras:', devices);

                    if (devices && devices.length > 0) {
                        // Use first camera or back camera if available
                        const backCamera = devices.find(device => 
                            device.label.toLowerCase().includes('back') || 
                            device.label.toLowerCase().includes('environment')
                        );
                        
                        const selectedCamera = backCamera || devices[0];
                        currentCameraId = selectedCamera.id;
                        
                        console.log('Selected camera:', selectedCamera);
                        
                        // Start scanning
                        html5QrCode.start(
                            selectedCamera.id,
                            {
                                fps: 10,
                                qrbox: { width: 250, height: 250 }
                            },
                            (decodedText, result) => {
                                console.log('QR Code scan successful:', decodedText);
                                onScanSuccess(decodedText);
                            },
                            (errorMessage) => {
                                // Don't show every error, only important ones
                                if (!errorMessage.includes('No QR code found')) {
                                    console.log('QR Scan error:', errorMessage);
                                }
                            }
                        ).then(() => {
                            updateScannerStatus('‚úÖ Scanner aktif. Arahkan kamera ke QR code.', 'success');
                        }).catch((err) => {
                            console.error('Unable to start scanning:', err);
                            updateScannerStatus('‚ùå Gagal memulai scanner: ' + err.message, 'error');
                        });
                    } else {
                        updateScannerStatus('‚ùå Tidak ada kamera yang ditemukan.', 'error');
                    }
                }).catch((err) => {
                    console.error('Camera enumeration error:', err);
                    
                    if (err.name === 'NotAllowedError' || err.message.includes('Permission denied')) {
                        updateScannerStatus('‚ùå Izin kamera ditolak. Silakan izinkan kamera di browser settings.', 'error');
                        
                        // Show instructions for enabling camera
                        setTimeout(() => {
                            updateScannerStatus('üí° Klik ikon üîí di address bar dan izinkan kamera, lalu refresh halaman.', 'warning');
                        }, 2000);
                    } else {
                        updateScannerStatus('‚ùå Gagal mengakses kamera: ' + err.message + '. Gunakan Manual Input.', 'error');
                    }
                    
                    // Focus on manual input as fallback
                    setTimeout(() => {
                        document.getElementById('manualInput').focus();
                        updateScannerStatus('üìù Gunakan Manual Input untuk memasukkan QR data.', 'info');
                    }, 3000);
                });

            } catch (error) {
                console.error('HTML5 QR Code initialization error:', error);
                updateScannerStatus('‚ùå Library scanner error. Gunakan input manual.', 'error');
            }
        }

        // Stop camera scanner
        function stopCameraScan() {
            console.log('=== STOPPING CAMERA SCANNER ===');
            
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    console.log('Scanner stopped successfully');
                    updateScannerStatus('‚èπÔ∏è Scanner dihentikan.', 'info');
                }).catch((err) => {
                    console.error('Failed to stop scanning:', err);
                    updateScannerStatus('‚ùå Gagal menghentikan scanner.', 'error');
                });
            } else {
                updateScannerStatus('‚èπÔ∏è Scanner tidak aktif.', 'info');
            }
        }

        // Switch camera
        function switchCamera() {
            if (!html5QrCode || cameras.length <= 1) {
                updateScannerStatus('‚ùå Hanya ada satu kamera tersedia.', 'warning');
                return;
            }

            // Find current camera index
            const currentIndex = cameras.findIndex(cam => cam.id === currentCameraId);
            
            // Try to find opposite camera type
            let nextCamera;
            const isBackCamera = cameras[currentIndex].label.toLowerCase().includes('back') || 
                                cameras[currentIndex].label.toLowerCase().includes('environment') ||
                                cameras[currentIndex].label.toLowerCase().includes('rear');
            
            if (isBackCamera) {
                // Switch to front camera
                nextCamera = cameras.find(device => 
                    device.label.toLowerCase().includes('front') || 
                    device.label.toLowerCase().includes('user')
                );
            } else {
                // Switch to back camera
                nextCamera = cameras.find(device => 
                    device.label.toLowerCase().includes('back') || 
                    device.label.toLowerCase().includes('environment') ||
                    device.label.toLowerCase().includes('rear')
                );
            }

            // If opposite camera not found, use next camera
            if (!nextCamera) {
                const nextIndex = (currentIndex + 1) % cameras.length;
                nextCamera = cameras[nextIndex];
            }

            // Stop current scanner and start with new camera
            if (html5QrCode && nextCamera) {
                html5QrCode.stop().then(() => {
                    currentCameraId = nextCamera.id;
                    console.log('Switching to camera:', nextCamera);
                    
                    // Restart with new camera
                    setTimeout(() => {
                        startCameraScan();
                    }, 500);
                }).catch((err) => {
                    console.error('Failed to stop for camera switch:', err);
                    updateScannerStatus('‚ùå Gagal mengganti kamera.', 'error');
                });
            }
        }

        // Handle successful scan
        function onScanSuccess(decodedText) {
            console.log('Scan successful:', decodedText);
            lastScanResult = decodedText;
            
            // Stop scanner
            stopCameraScan();
            
            // Show result
            document.getElementById('resultContent').textContent = decodedText;
            document.getElementById('resultSection').style.display = 'block';
            updateScannerStatus('‚úÖ Scan berhasil! Mengirim ke Dashboard...', 'success');
            
            // Auto-send to dashboard after 1 second
            setTimeout(() => {
                sendToAppsScript();
            }, 1000);
        }

        // Process manual input
        function processManualInput() {
            const manualValue = document.getElementById('manualInput').value.trim();
            if (manualValue) {
                onScanSuccess(manualValue);
                document.getElementById('manualInput').value = '';
            } else {
                updateScannerStatus('‚ö†Ô∏è Masukkan QR/Barcode terlebih dahulu', 'warning');
            }
        }

        // Clear manual input
        function clearManualInput() {
            document.getElementById('manualInput').value = '';
        }

        // Copy result to clipboard
        function copyResult() {
            if (lastScanResult) {
                navigator.clipboard.writeText(lastScanResult).then(() => {
                    updateScannerStatus('üìã Hasil disalin ke clipboard!', 'success');
                }).catch(err => {
                    updateScannerStatus('‚ùå Gagal menyalin hasil', 'error');
                });
                updateScannerStatus('‚ö†Ô∏è Tidak ada hasil untuk disalin', 'warning');
            }
        }

        // Send result back to Dashboard via postMessage or Apps Script GET
        function sendToAppsScript() {
            console.log('=== sendToAppsScript called ===');
            console.log('lastScanResult:', lastScanResult);
            
            if (!lastScanResult) {
                updateScannerStatus('‚ö†Ô∏è Tidak ada hasil untuk dikirim', 'warning');
                return;
            }
            
            const processId = getUrlParameter('processId') || 'ext_' + Date.now();
            const mode = getUrlParameter('mode') || 'postMessage';
            console.log('Process ID:', processId);
            console.log('Mode:', mode);
            
            // Try postMessage first (if opener is available)
            try {
                console.log('Checking window.opener:', window.opener);
                console.log('window.opener.closed:', window.opener ? window.opener.closed : 'N/A');
                
                if (window.opener && !window.opener.closed) {
                    const messageData = {
                        type: 'QR_SCAN_RESULT',
                        qrResult: lastScanResult,
                        processId: processId,
                        timestamp: new Date().toISOString(),
                        source: 'external_scanner'
                    };
                    
                    console.log('üì§ SENDING POSTMESSAGE:', messageData);
                    window.opener.postMessage(messageData, '*');
                    
                    console.log('‚úÖ Sent result via postMessage');
                    updateScannerStatus('‚úÖ Hasil dikirim ke Dashboard via postMessage', 'success');
                    
                    // Close after a short delay
                    setTimeout(() => {
                        window.close();
                    }, 1500);
                    return;
                } else {
                    console.log('‚ùå Window opener not available or closed, trying Apps Script GET...');
                }
            } catch (error) {
                console.error('‚ùå postMessage failed, trying Apps Script GET:', error);
            }
            
            // Fallback: Send to Apps Script via URL redirect (bypass CORS)
            updateScannerStatus('üì§ Mengirim ke Apps Script via redirect...', 'info');
            
            // Get returnUrl from URL parameters
            const returnUrl = getUrlParameter('returnUrl');
            console.log('Return URL:', returnUrl);
            
            // Use URL redirect to bypass CORS
            const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbzcpuVqth4CpNkvMi8HWx2C0rVhsNO8uG6PIE4BKzwOYqN5dS766hlpdPPXYZsEDjil/exec';
            
            // Build redirect URL with QR data
            const params = new URLSearchParams({
                qrResult: lastScanResult,
                source: 'external_scanner',
                processId: processId,
                timestamp: new Date().toISOString(),
                returnUrl: returnUrl, // Pass returnUrl for redirect back
                redirectBack: 'true' // Enable redirect back to dashboard
            });
            
            const redirectUrl = appsScriptUrl + '?' + params.toString();
            console.log('Redirect URL:', redirectUrl);
            
            // Show success message before redirect
            updateScannerStatus('‚úÖ Mengirim data ke Apps Script... Halaman akan dialihkan.', 'success');
            
            // Redirect to Apps Script (bypasses CORS)
            setTimeout(() => {
                window.location.href = redirectUrl;
            }, 1500);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('QR Scanner External Page Loaded');
            console.log('Current URL:', window.location.href);
            console.log('URL Parameters:', window.location.search);
            
            // Get URL parameters
            const returnUrl = getUrlParameter('returnUrl') || getUrlParameter('return');
            const title = getUrlParameter('title') || 'QR Scanner';
            const processId = getUrlParameter('processId') || 'process_' + Date.now();
            
            console.log('Return URL:', returnUrl);
            console.log('Title:', title);
            console.log('Process ID:', processId);
            
            // Update page title
            if (title) {
                document.title = title;
            }
            
            // Always show success message since we have parameters
            if (returnUrl) {
                updateScannerStatus('‚úÖ Scanner siap. Hasil akan dikirim ke Dashboard.', 'success');
            } else {
                updateScannerStatus('‚ö†Ô∏è Scanner siap. Mode standalone (no return URL).', 'info');
            }
            
            // Auto-focus manual input
            document.getElementById('manualInput').focus();
            
            // Auto-start camera scanner
            setTimeout(() => {
                startCameraScan();
            }, 1000);
        });
    </script>
</body>
</html>
