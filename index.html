<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="camera=(self), microphone=()">
    <title>QR Scanner - Production Line Tracker</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
            color: #ffffff;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            animation: fadeIn 0.8s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #3c3c3c 0%, #4a4a4a 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .scanner-section {
            background: linear-gradient(135deg, #3c3c3c 0%, #4a4a4a 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
        }

        .scanner-status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
        }

        .scanner-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .scanner-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .scanner-status.info {
            background: #4a4a4a;
            color: white;
            border: 1px solid #5a5a5a;
        }

        .scanner-status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #e55a2b 0%, #ff6b35 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a4a4a 0%, #5a5a5a 100%);
            box-shadow: 0 4px 15px rgba(74, 74, 74, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #3a3a3a 0%, #4a4a4a 100%);
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .result-section {
            background: linear-gradient(135deg, #3c3c3c 0%, #4a4a4a 100%);
            border-radius: 15px;
            padding: 30px;
            margin-top: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            display: none;
        }

        .result-content {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #4a4a4a;
            word-break: break-all;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            color: #00ff00;
        }

        .manual-input {
            margin: 20px 0;
        }

        .manual-input input {
            width: 100%;
            padding: 15px;
            border: 2px solid #4a4a4a;
            border-radius: 8px;
            background: #2a2a2a;
            color: white;
            font-size: 16px;
            font-family: 'Courier New', monospace;
        }

        .manual-input input:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 10px rgba(255, 107, 53, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            #qr-reader {
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∑ QR/Barcode Scanner</h1>
            <p>Production Line Tracker - AQUATEAK 2026</p>
        </div>

        <div class="scanner-section">
            <div id="scannerStatus" class="scanner-status info">
                üîÑ Siap untuk scanning...
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="startCameraScan()">üì∏ Start Camera</button>
                <button class="btn" onclick="stopCameraScan()">‚èπÔ∏è Stop Camera</button>
                <button class="btn btn-primary" onclick="switchCamera()">üîÑ Switch Camera</button>
                <button class="btn btn-warning" onclick="debugCamera()">üîç Debug Camera</button>
                <button class="btn btn-info" onclick="testBasicCameraAccess()">üß™ Test Basic Access</button>
            </div>

            <div id="qr-reader"></div>

            <div class="manual-input">
                <h3>üìù Manual Input (Alternatif)</h3>
                <input type="text" id="manualInput" placeholder="Masukkan QR/Barcode secara manual..." 
                       onkeypress="if(event.key === 'Enter') processManualInput()">
                <div class="button-group">
                    <button class="btn btn-primary" onclick="processManualInput()">üîç Process Manual</button>
                </div>
            </div>
        </div>

        <div id="resultSection" class="result-section">
            <h3>‚úÖ Scan Result</h3>
            <div id="resultContent" class="result-content"></div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="sendToAppsScript()">üì§ Kirim ke Apps Script</button>
                <button class="btn" onclick="resetScanner()">üîÑ Scan Lagi</button>
            </div>
        </div>
    </div>

    <script>
        let html5QrCode = null;
        let cameras = [];
        let currentCameraId = null;
        let lastScanResult = null;

        // Get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Update scanner status
        function updateScannerStatus(message, type = 'info') {
            const statusElement = document.getElementById('scannerStatus');
            statusElement.textContent = message;
            statusElement.className = 'scanner-status ' + type;
        }

        // Start camera scanner
        function startCameraScan() {
            console.log('=== STARTING CAMERA SCANNER ===');
            updateScannerStatus('üîÑ Memulai scanner...', 'info');
            
            // Check camera support
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateScannerStatus('‚ùå Browser tidak mendukung kamera. Gunakan Chrome/Firefox terbaru.', 'error');
                return;
            }
            
            // Clear previous scanner
            if (html5QrCode) {
                html5QrCode.clear();
            }
            
            // Initialize scanner
            html5QrCode = new Html5Qrcode("qr-reader");
            
            // Get available cameras with better error handling
            Html5Qrcode.getCameras().then(devices => {
                console.log('Available cameras:', devices);
                cameras = devices;
                
                if (devices && devices.length > 0) {
                    // Use first available camera (more reliable)
                    const selectedCamera = devices[0];
                    currentCameraId = selectedCamera.id;
                    
                    console.log('Using camera:', selectedCamera.label || 'Camera ' + (devices.indexOf(selectedCamera) + 1));
                    updateScannerStatus('üì∑ Menggunakan kamera: ' + (selectedCamera.label || 'Kamera utama'), 'info');
                    
                    // Start scanning with more permissive config
                    html5QrCode.start(
                        selectedCamera,
                        {
                            fps: 5, // Lower FPS for better compatibility
                            qrbox: { width: 200, height: 200 }, // Smaller box
                            aspectRatio: 1.0
                        },
                        (decodedText, decodedResult) => {
                            console.log('QR Code detected:', decodedText);
                            onScanSuccess(decodedText);
                        },
                        (errorMessage) => {
                            // Don't log every error to reduce console spam
                            if (!errorMessage.includes('No QR code found') && 
                                !errorMessage.includes('No barcode') &&
                                !errorMessage.includes('NotFoundException')) {
                                console.log('Scan error:', errorMessage);
                            }
                        }
                    ).then(() => {
                        console.log('Scanner started successfully');
                        updateScannerStatus('‚úÖ Scanner aktif. Arahkan ke QR Code atau Barcode.', 'success');
                    }).catch((error) => {
                        console.error('Scanner start error:', error);
                        handleCameraError(error);
                    });
                } else {
                    updateScannerStatus('‚ùå Tidak ada kamera ditemukan. Gunakan Manual Input.', 'error');
                    showManualInputFallback();
                }
            }).catch((error) => {
                console.error('Camera enumeration error:', error);
                handleCameraError(error);
            });
        }

        // Handle camera errors with better messages
        function handleCameraError(error) {
            let errorMsg = '‚ùå Gagal mengakses kamera';
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                errorMsg = '‚ùå Izin kamera ditolak. Solusi:\n1. Klik ikon gembok/üîí di address bar\n2. Pilih "Allow" atau "Izinkan"\n3. Refresh halaman (F5)\n4. Coba lagi';
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError' || error.message.includes('Requested device not found')) {
                errorMsg = '‚ùå Tidak ada kamera ditemukan. Solusi:\n1. Pastikan kamera terhubung\n2. Coba gunakan HP/lain device\n3. Gunakan Manual Input\n4. Periksa driver kamera';
            } else if (error.name === 'NotSupportedError') {
                errorMsg = '‚ùå Browser tidak mendukung kamera. Gunakan Chrome, Firefox, atau Edge terbaru.';
            } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                errorMsg = '‚ùå Kamera sedang digunakan aplikasi lain. Tutup:\n1. Video call (Zoom, Meet, Teams)\n2. Aplikasi kamera lain\n3. Tab browser lain yang pakai kamera';
            } else if (error.name === 'OverconstrainedError') {
                errorMsg = '‚ùå Kamera tidak memenuhi requirements. Coba:\n1. Gunakan kamera lain\n2. Restart browser\n3. Gunakan Manual Input';
            } else if (error.message.includes('Permission denied')) {
                errorMsg = '‚ùå Izin kamera ditolak. Klik ikon gembok üîí di address bar dan izinkan kamera.';
            } else {
                errorMsg = '‚ùå Error kamera: ' + error.message + '\n\nSolusi: Gunakan Manual Input sebagai alternatif.';
            }
            
            updateScannerStatus(errorMsg, 'error');
            showManualInputFallback();
        }

        // Debug camera function
        function debugCamera() {
            console.log('=== CAMERA DEBUG INFO ===');
            updateScannerStatus('üîç Mengecek informasi kamera...', 'info');
            
            let debugInfo = 'üìã Camera Debug Information:\n\n';
            
            // Browser info
            debugInfo += 'üåê Browser:\n';
            debugInfo += '- Name: ' + navigator.userAgent + '\n';
            debugInfo += '- Platform: ' + navigator.platform + '\n';
            debugInfo += '- Language: ' + navigator.language + '\n\n';
            
            // Media devices support
            debugInfo += 'üì± Media Devices Support:\n';
            debugInfo += '- mediaDevices: ' + (navigator.mediaDevices ? '‚úÖ Available' : '‚ùå Not Available') + '\n';
            debugInfo += '- getUserMedia: ' + (navigator.mediaDevices && navigator.mediaDevices.getUserMedia ? '‚úÖ Available' : '‚ùå Not Available') + '\n';
            debugInfo += '- enumerateDevices: ' + (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices ? '‚úÖ Available' : '‚ùå Not Available') + '\n\n';
            
            // HTTPS check
            debugInfo += 'üîí Security:\n';
            debugInfo += '- Protocol: ' + window.location.protocol + '\n';
            debugInfo += '- HTTPS: ' + (window.location.protocol === 'https:' ? '‚úÖ Secure' : '‚ö†Ô∏è Not Secure (camera may not work)') + '\n';
            debugInfo += '- Hostname: ' + window.location.hostname + '\n\n';
            
            updateScannerStatus(debugInfo, 'info');
            
            // Try to enumerate devices
            if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        console.log('All devices:', devices);
                        
                        let deviceInfo = '\nüìπ Found Devices:\n';
                        const videoDevices = devices.filter(device => device.kind === 'videoinput');
                        const audioDevices = devices.filter(device => device.kind === 'audioinput');
                        
                        deviceInfo += '- Video inputs: ' + videoDevices.length + '\n';
                        videoDevices.forEach((device, index) => {
                            deviceInfo += '  ' + (index + 1) + '. ' + (device.label || 'Unknown Camera') + ' (ID: ' + device.deviceId.substring(0, 8) + '...)\n';
                        });
                        
                        deviceInfo += '- Audio inputs: ' + audioDevices.length + '\n';
                        audioDevices.forEach((device, index) => {
                            deviceInfo += '  ' + (index + 1) + '. ' + (device.label || 'Unknown Microphone') + '\n';
                        });
                        
                        if (videoDevices.length === 0) {
                            deviceInfo += '\n‚ö†Ô∏è No camera devices found!\n';
                            deviceInfo += 'Possible solutions:\n';
                            deviceInfo += '1. Connect a camera\n';
                            deviceInfo += '2. Use a different device (phone/tablet)\n';
                            deviceInfo += '3. Check camera drivers\n';
                            deviceInfo += '4. Try different browser\n';
                        }
                        
                        updateScannerStatus(debugInfo + deviceInfo, 'info');
                        
                        // Store devices for later use
                        cameras = videoDevices;
                        console.log('Stored cameras:', cameras);
                        
                    })
                    .catch(error => {
                        console.error('Error enumerating devices:', error);
                        updateScannerStatus(debugInfo + '\n‚ùå Error getting device list: ' + error.message, 'error');
                    });
            } else {
                updateScannerStatus(debugInfo + '\n‚ùå Device enumeration not supported', 'error');
            }
        }

        // Test basic camera access
        function testBasicCameraAccess() {
            console.log('Testing basic camera access...');
            updateScannerStatus('üîç Menguji akses kamera dasar...', 'info');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateScannerStatus('‚ùå Browser tidak mendukung getUserMedia', 'error');
                return;
            }
            
            // Try very basic camera request
            navigator.mediaDevices.getUserMedia({ 
                video: true,
                audio: false 
            })
            .then(function(stream) {
                console.log('Basic camera access successful!');
                console.log('Stream tracks:', stream.getTracks());
                
                // Get video track info
                const videoTracks = stream.getVideoTracks();
                if (videoTracks.length > 0) {
                    const track = videoTracks[0];
                    console.log('Video track:', track);
                    console.log('Track settings:', track.getSettings());
                    console.log('Track capabilities:', track.getCapabilities());
                    
                    let successInfo = '‚úÖ Basic camera access successful!\n\n';
                    successInfo += 'üìπ Video Track Info:\n';
                    successInfo += '- Label: ' + (track.label || 'Unknown') + '\n';
                    successInfo += '- Enabled: ' + track.enabled + '\n';
                    successInfo += '- Muted: ' + track.muted + '\n';
                    successInfo += '- State: ' + track.readyState + '\n';
                    
                    const settings = track.getSettings();
                    successInfo += '\n‚öôÔ∏è Settings:\n';
                    successInfo += '- Width: ' + settings.width + '\n';
                    successInfo += '- Height: ' + settings.height + '\n';
                    successInfo += '- Frame Rate: ' + settings.frameRate + '\n';
                    
                    updateScannerStatus(successInfo, 'success');
                    
                    // Stop the test stream
                    stream.getTracks().forEach(track => track.stop());
                }
                
            })
            .catch(function(error) {
                console.error('Basic camera access failed:', error);
                handleCameraError(error);
            });
        }

        // Show manual input fallback
        function showManualInputFallback() {
            setTimeout(() => {
                document.getElementById('manualInput').focus();
                updateScannerStatus('üí° Gunakan Manual Input atau coba dengan device lain (HP/tablet)', 'info');
            }, 2000);
        }

        // Stop camera scanner
        function stopCameraScan() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    console.log('Scanner stopped');
                    updateScannerStatus('‚èπÔ∏è Scanner dihentikan', 'info');
                }).catch((error) => {
                    console.error('Error stopping scanner:', error);
                });
            }
        }

        // Switch camera
        function switchCamera() {
            if (cameras.length <= 1) {
                updateScannerStatus('‚ö†Ô∏è Hanya ada satu kamera tersedia', 'warning');
                return;
            }
            
            const currentIndex = cameras.findIndex(cam => cam.id === currentCameraId);
            const nextIndex = (currentIndex + 1) % cameras.length;
            const nextCamera = cameras[nextIndex];
            
            stopCameraScan();
            
            setTimeout(() => {
                currentCameraId = nextCamera.id;
                html5QrCode = new Html5Qrcode("qr-reader");
                
                html5QrCode.start(
                    nextCamera,
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0
                    },
                    (decodedText, decodedResult) => {
                        onScanSuccess(decodedText);
                    },
                    (errorMessage) => {
                        // Handle scan errors silently
                    }
                ).then(() => {
                    updateScannerStatus('‚úÖ Camera diganti ke: ' + (nextCamera.label || 'Camera ' + (nextIndex + 1)), 'success');
                }).catch((error) => {
                    updateScannerStatus('‚ùå Gagal ganti kamera: ' + error.message, 'error');
                });
            }, 500);
        }

        // Handle successful scan
        function onScanSuccess(decodedText) {
            console.log('Scan successful:', decodedText);
            lastScanResult = decodedText;
            
            // Stop scanner
            stopCameraScan();
            
            // Show result
            document.getElementById('resultContent').textContent = decodedText;
            document.getElementById('resultSection').style.display = 'block';
            updateScannerStatus('‚úÖ Scan berhasil! Periksa hasil di bawah.', 'success');
            
            // Scroll to result
            document.getElementById('resultSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Process manual input
        function processManualInput() {
            const manualValue = document.getElementById('manualInput').value.trim();
            if (manualValue) {
                onScanSuccess(manualValue);
                document.getElementById('manualInput').value = '';
            } else {
                updateScannerStatus('‚ö†Ô∏è Masukkan QR/Barcode terlebih dahulu', 'warning');
            }
        }

        // Send result back to Apps Script
        function sendToAppsScript() {
            if (!lastScanResult) {
                updateScannerStatus('‚ö†Ô∏è Tidak ada hasil untuk dikirim', 'warning');
                return;
            }
            
            // Get the return URL from URL parameter or use default
            const returnUrl = getUrlParameter('returnUrl') || getUrlParameter('return');
            const processId = getUrlParameter('processId') || 'default';
            
            if (returnUrl) {
                // Try to send via postMessage first (if opener is available)
                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage({
                            type: 'QR_SCAN_RESULT',
                            qrResult: lastScanResult,
                            processId: processId,
                            timestamp: new Date().toISOString(),
                            source: 'external_scanner'
                        }, '*');
                        
                        console.log('Sent result via postMessage');
                        updateScannerStatus('‚úÖ Hasil dikirim ke Apps Script', 'success');
                        
                        // Close after a short delay
                        setTimeout(() => {
                            window.close();
                        }, 1500);
                        return;
                    }
                } catch (error) {
                    console.log('postMessage failed, using URL redirect:', error);
                }
                
                // Fallback: Construct return URL with scan result
                const returnParams = new URLSearchParams({
                    qrResult: lastScanResult,
                    processId: processId,
                    timestamp: new Date().toISOString(),
                    source: 'external_scanner'
                });
                
                const finalUrl = returnUrl + (returnUrl.includes('?') ? '&' : '?') + returnParams.toString();
                
                console.log('Returning to Apps Script via URL:', finalUrl);
                updateScannerStatus('üì§ Mengirim hasil ke Apps Script...', 'info');
                
                // Redirect back to Apps Script
                setTimeout(() => {
                    window.location.href = finalUrl;
                }, 1000);
            } else {
                updateScannerStatus('‚ö†Ô∏è URL return tidak ditemukan. Tidak bisa mengirim ke Apps Script.', 'warning');
            }
        }

        // Reset scanner
        function resetScanner() {
            lastScanResult = null;
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('resultContent').textContent = '';
            updateScannerStatus('üîÑ Siap untuk scanning...', 'info');
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('QR Scanner External Page Loaded');
            
            // Check if we have return URL
            const returnUrl = getUrlParameter('returnUrl') || getUrlParameter('return');
            if (returnUrl) {
                updateScannerStatus('‚úÖ Scanner siap. Hasil akan dikirim ke Apps Script setelah scan.', 'success');
            } else {
                updateScannerStatus('‚ö†Ô∏è Mode standalone. Hasil scan tidak akan dikirim ke Apps Script.', 'warning');
            }
            
            // Auto-focus manual input
            document.getElementById('manualInput').focus();
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && html5QrCode) {
                stopCameraScan();
            }
        });
    </script>
</body>
</html>
